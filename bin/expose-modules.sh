#!/bin/sh

SRC="$1/src"

magic="// File generated by CQES"
header="$magic
// Do not edit
"

for dir in $(\ls "$SRC")
do
    module=$(basename "$dir")
    from="$SRC/$dir"
    file="$from/index.ts"
    if [ ! -e "$file" ] || grep "$magic" "$file" > /dev/null 2> /dev/null
    then
        echo "Generate $module exposure for:" > /dev/stderr
        imports=''
        exports=''
        ## ValueObject
        if [ -e "$from/$module.ValueObject.ts" ]
        then
            echo "  - Value" > /dev/stderr
            imports="$imports\nimport { ${module} } from './$module.Value'"
            exports="$exports\nexport const ${module} = ${module}"
        ## Entity
        elif [ -e "$from/$module.Entity.ts" ]
        then
            echo "  - Entity" > /dev/stderr
            imports="$imports\nimport { ${module}Entity } from './$module.Entity'"
            exports="$exports\nexport const ${module}Entity = ${module}Entity"
        ## Aggregate
        elif [ -e "$from/$module.Aggregate.ts" ]
        then
            echo "  - Aggregate" > /dev/stderr
            imports="$imports\nimport { Aggregate } from './$module.Aggregate'"
            exports="$exports\nexport const Aggregate = ${module}"
            ## Factory
            if [ -e "$from/$module.Factory.ts" ]
            then
                echo "  - Factory" > /dev/stderr
                exports="$exports\nexport { $module } from './$module.Factory'"
                ## Manager
                if [ -e "$from/$module.Manager.ts" ]
                then
                    echo "  - Manager" > /dev/stderr
                    exports="$exports\nexport { $module } from './$module.Manager'"
                ## Saga
                elif [ -e "$from/$module.Saga.ts" ]
                then
                    echo "  - Saga" > /dev/stderr
                    exports="$exports\nexport { $module } from './$module.Saga'"
                ## Projector
                elif [ -e "$from/$module.Projector.ts" ]
                then
                    echo "  - Projector" > /dev/stderr
                    exports="$exports\nexport { $module } from './$module.Projector'"
                ## Gateway
                elif [ -e "$from/$module.Gateway.ts" ]
                then
                    echo "  - Gateway" > /dev/stderr
                    exports="$exports\nexport { $module } from './$module.Gateway'"
                    ## Repository
                    if [ -e "$from/$module.Repository.ts" ]
                    then
                        echo "  - Repository" > /dev/stderr
                        exports="$exports\nexport { $module } from './$module.Repository'"
                    fi
                fi
            fi
        fi
        echo "$header" > "$file"
        echo "$imports" >> "$file"
        echo "$exports" >> "$file"
    else
        echo "Can not overwrite file $file, not generated by CQES"
        exit 1
    fi
done
